{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "location": {
        "type": "string"
      },
      "sqlServerActiveDirectoryAdminLogin": {
        "type": "string"
      },
      "sqlServerActiveDirectoryAdminObjectId": {
        "type": "string"
      },
      "sqlServerMinimalTlsVersion": {
        "type": "string"
      },
      "sqlServerPassword": {
        "type": "string"
      },
      "sqlServerUser": {
        "type": "string"
      },
      "tags": {
        "type": "object"
      },
      "threatDetectionEmailAddress": {
        "type": "string"
      }
    },
    "variables": {
      "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/",
      "resourceNamePrefix": "das-ci-tests"
    },
    "resources": [
      {
        "apiVersion": "2025-04-01",
        "name": "[concat(variables('resourceNamePrefix'), '-rg')]",
        "type": "Microsoft.Resources/resourceGroups",
        "location": "[parameters('location')]",
        "tags": "[parameters('tags')]",
        "properties": {}
      },
      {
        "apiVersion": "2025-04-01",
        "name": "ci-tests-storage-deployment",
        "resourceGroup": "[concat(variables('resourceNamePrefix'), '-rg')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[uri(variables('deploymentUrlBase'),'storage-account-arm.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "allowSharedKeyAccess": {
              "value": true
            },
            "storageAccountLocation": {
              "value": "[parameters('location')]"
            },
            "storageAccountName": {
              "value": "[concat(replace(variables('resourceNamePrefix'), '-', ''), 'str')]"
            }
          }
        },
        "dependsOn": [
          "[concat(variables('resourceNamePrefix'), '-rg')]"
        ]
      },
      {
        "apiVersion": "2025-04-01",
        "name": "ci-tests-sql-server-deployment",
        "resourceGroup": "[concat(variables('resourceNamePrefix'), '-rg')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[uri(variables('deploymentUrlBase'),'sql-server.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "sqlServerActiveDirectoryAdminLogin": {
              "value": "[parameters('sqlServerActiveDirectoryAdminLogin')]"
            },
            "sqlServerActiveDirectoryAdminObjectId": {
              "value": "[parameters('sqlServerActiveDirectoryAdminObjectId')]"
            },
            "sqlServerAdminPassword": {
              "value": "[parameters('sqlServerPassword')]"
            },
            "sqlServerAdminUserName": {
              "value": "[parameters('sqlServerUser')]"
            },
            "sqlServerLocation": {
              "value": "[parameters('location')]"
            },
            "sqlServerMinimalTlsVersion": {
              "value": "[parameters('sqlServerMinimalTlsVersion')]"
            },
            "sqlServerName": {
              "value": "[concat(variables('resourceNamePrefix'), '-sql')]"
            },
            "sqlStorageAccountName": {
              "value": "[concat(variables('resourceNamePrefix'), '-str')]"
            },
            "threatDetectionEmailAddress": {
              "value": "[parameters('threatDetectionEmailAddress')]"
            }
          }
        },
        "dependsOn": [
          "ci-tests-storage-deployment"
        ]
      },
      {
        "apiVersion": "2025-04-01",
        "name": "ci-tests-sql-server-firewall-rule-deployment",
        "resourceGroup": "[concat(variables('resourceNamePrefix'), '-rg')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[uri(variables('deploymentUrlBase'),'sql-server-firewall-rules.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "firewallRuleNamePrefix": {
              "name": "AllowAzure"
            },
            "ipAddresses": {
              "value": ["0.0.0.0"]
            },
            "serverName": {
              "value": "[concat(variables('resourceNamePrefix'), '-sql')]"
            }
          }
        },
        "dependsOn": [
          "ci-tests-sql-server-deployment"
        ]
      }
    ]
}
