trigger: none

variables:
- name: SolutionBaseName
  value: Recruit.Api
- name: BuildConfiguration
  value: release
- group: DevTest Management Resources
- group: das-ci-tests

resources:
  repositories:
  - repository: self
  - repository: das-platform-building-blocks
    type: github
    name: SkillsFundingAgency/das-platform-building-blocks
    ref: refs/tags/3.0.14
    endpoint: SkillsFundingAgency
  - repository: das-platform-automation
    type: github
    name: SkillsFundingAgency/das-platform-automation
    ref: refs/tags/5.1.20
    endpoint: SkillsFundingAgency

stages:
- stage: Build
  pool:
    name: DAS - Continuous Integration Agents
  jobs:
  - job: CodeBuild
    workspace:
      clean: all
    variables:
    - group: BUILD Management Resources
    steps:
    - checkout: self
      fetchDepth: 0
    - task: CopyFiles@2
      displayName: Copy Files to $(build.artifactstagingdirectory)/publish
      inputs:
        Contents: |
          azure/**
          src/**
        TargetFolder: $(build.artifactstagingdirectory)/publish
        OverWrite: true
    - task: PublishPipelineArtifact@1
      displayName: Publish Build Artifact
      inputs:
        targetPath: $(build.artifactstagingdirectory)/publish
        artifactName: drop
  
  - template: azure-pipelines-templates/build/job/dacpaccs-template.yml@das-platform-building-blocks
    parameters:
      SolutionBaseName: ${{ variables.SolutionBaseName }}
      DatabaseProjectPath: src/${{ variables.SolutionBaseName }}.Database/${{ variables.SolutionBaseName }}.Database.csproj

- stage: Deploy
  displayName: Deploy SQL DB and Run Tests
  pool:
    name: DAS - Continuous Deployment Agents
  jobs:
  # - deployment: DeploySQLServer
  #   displayName: Deploy SQL Server
  #   environment: AT
  #   strategy:
  #     runOnce:
  #       deploy:
  #         steps:
  #         - template: azure-pipelines-templates/deploy/step/wait-azure-devops-deployment.yml@das-platform-building-blocks
  #           parameters:
  #             ServiceConnection: $(ARMServiceConnection)
  #             EnvironmentId: $(Environment.Id)
  #             PipelineName: $(Build.DefinitionName)
  #             RunId: $(Build.BuildId)
  #         - template: azure-pipelines-templates/deploy/step/arm-deploy.yml@das-platform-building-blocks
  #           parameters:
  #             ServiceConnection: $(ARMServiceConnection)
  #             SubscriptionId: $(SubscriptionId)
  #             Location: $(location)
  #             Environment: DEV
  #             TemplatePath: $(Pipeline.Workspace)/drop/azure/template-sql-server.json
  #             ParametersPath: $(Pipeline.Workspace)/drop/azure/template-sql-server.parameters.json
  #             IsMultiRepoCheckout: true
  #             TemplateSecrets:
  #               SqlServerPassword: $(sqlServerPassword)

  - job: Test
    displayName: Run Integration Tests
    # dependsOn: DeploySQLServer
    variables:
      resourceGroupName: das-ci-tests-rg  
      sqlServerName: das-ci-tests-sql
      serverName: das-ci-tests-sql.database.windows.net
    steps:
    - checkout: das-platform-automation
    - download: current
      artifact: DacpacArtifact

    - task: SqlAzureDacpacDeployment@1
      displayName: Execute Azure SQL DacpacTask
      inputs:
        AzureSubscription: $(ARMServiceConnection)
        ServerName: $(serverName)
        DatabaseName: $(sqlDB)
        SqlUsername: $(sqlServerUser)
        SqlPassword: $(sqlServerPassword)
        DacpacFile:  $(Pipeline.Workspace)/DacpacArtifact/src/${{ variables.SolutionBaseName }}.Database/bin/release/netstandard2.1/${{ variables.SolutionBaseName }}.Database.dacpac

    - powershell: |
        Write-Host "##vso[task.setvariable variable=ADO_CONNSTR;issecret=true]Server=tcp:$(serverName),1433;Initial Catalog=$(sqlDB);Persist Security Info=False;User ID=$(sqlServerUser);Password=$(sqlServerPassword);MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
      displayName: Set Connection String Variable

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # (Optional) run schema/migrations for tests
    - powershell: |
        dotnet tool install --global dotnet-ef
        $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
        # adjust project paths as needed:
        # dotnet ef database update --project src/App/App.csproj --startup-project tests/Tests/Tests.csproj --connection "$(ADO_CONNSTR)"
      displayName: 'Apply DB migrations (optional)'
      condition: succeeded()

    # Unit tests
    - powershell: |
        dotnet test --configuration "Release" --filter 'TestCategory!=Integration'
      displayName: 'Run Unit Tests'
      workingDirectory: src

    # Integration tests (point SQL DB)
    - powershell: |
        $env:ConnectionStrings__Integration = $(ADO_CONNSTR)
        $env:IntegrationTestsDbSchemaName = $(sqlDB)
        dotnet test --configuration "Release" --filter 'TestCategory=Integration'
      displayName: 'Run Integration Tests'
      workingDirectory: src

    # Cleanup (best-effort)
    - task: AzureCLI@2
      displayName: 'Tear down SQL DB'
      condition: always()
      inputs:
        azureSubscription: $(ARMServiceConnection)
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          Remove-AzSqlDatabase -DatabaseName "$(sqlDB)" -ResourceGroupName "$(resourceGroupName)" -ServerName "$(sqlServerName)" -Force
